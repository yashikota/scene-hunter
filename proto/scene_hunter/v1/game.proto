syntax = "proto3";

package scene_hunter.v1;

import "buf/validate/validate.proto";

option go_package = "github.com/yashikota/scene-hunter/server/gen/scene_hunter/v1;scene_hunterv1";

// GameStatus represents the current status of the game.
enum GameStatus {
  GAME_STATUS_UNSPECIFIED = 0;
  GAME_STATUS_WAITING = 1; // Waiting for players to join
  GAME_STATUS_IN_PROGRESS = 2; // Game is currently in progress
  GAME_STATUS_FINISHED = 3; // Game has ended
}

// TurnStatus represents the current status of a turn.
enum TurnStatus {
  TURN_STATUS_UNSPECIFIED = 0;
  TURN_STATUS_GAME_MASTER = 1; // Game master's turn (taking photo)
  TURN_STATUS_HUNTERS = 2; // Hunters' turn (finding location)
  TURN_STATUS_WAITING_FOR_SELECTION = 3; // All hunters submitted, waiting for game master to select winners
}

// Player represents a player in the game.
message Player {
  string user_id = 1 [(buf.validate.field).string.uuid = true];
  string name = 2 [(buf.validate.field).string = {
    min_len: 1
    max_len: 20
  }];
  bool is_game_master = 3;
  bool is_admin = 4;
  int32 total_points = 5;
  bool is_connected = 6;
}

// Hint represents a single hint for hunters.
message Hint {
  int32 hint_number = 1 [(buf.validate.field).int32 = {
    gte: 1
    lte: 5
  }];
  string text = 2;
}

// HunterSubmission represents a hunter's photo submission.
message HunterSubmission {
  string user_id = 1 [(buf.validate.field).string.uuid = true];
  string image_id = 2;
  int32 submitted_at_seconds = 3 [(buf.validate.field).int32 = {
    gte: 0
    lte: 60
  }];
}

// RoundResult represents the result of a single round for a player.
message RoundResult {
  string user_id = 1 [(buf.validate.field).string.uuid = true];
  int32 rank = 2 [(buf.validate.field).int32 = {
    gte: 1
    lte: 20
  }]; // Rank assigned by game master (1st, 2nd, 3rd, etc.)
  int32 points = 3; // Points awarded based on rank
}

// Round represents a single round in the game.
message Round {
  int32 round_number = 1;
  string game_master_user_id = 2 [(buf.validate.field).string.uuid = true];
  string game_master_image_id = 3; // Image ID of game master's photo
  repeated Hint hints = 4;
  repeated HunterSubmission hunter_submissions = 5; // Photos submitted by hunters
  repeated RoundResult results = 6; // Results after game master selects winners
  TurnStatus turn_status = 7;
  int32 turn_elapsed_seconds = 8;
}

// Game represents a game session.
message Game {
  string room_id = 1 [(buf.validate.field).string.uuid = true];
  GameStatus status = 2;
  int32 total_rounds = 3 [(buf.validate.field).int32 = {
    gte: 1
    lte: 5
  }];
  int32 current_round = 4;
  repeated Player players = 5;
  repeated Round rounds = 6;
  string created_at = 7;
  string updated_at = 8;
}

// StartGameRequest starts a new game.
message StartGameRequest {
  string room_id = 1 [(buf.validate.field).string.uuid = true];
  int32 total_rounds = 2 [(buf.validate.field).int32 = {
    gte: 1
    lte: 5
  }];
  string game_master_user_id = 3 [(buf.validate.field).string.uuid = true];
}

message StartGameResponse {
  Game game = 1;
}

// JoinGameRequest allows a player to join a game.
message JoinGameRequest {
  string room_id = 1 [(buf.validate.field).string.uuid = true];
  string user_id = 2 [(buf.validate.field).string.uuid = true];
  string name = 3 [(buf.validate.field).string = {
    min_len: 1
    max_len: 20
  }];
}

message JoinGameResponse {
  Game game = 1;
}

// SubmitGameMasterPhotoRequest submits the game master's photo.
message SubmitGameMasterPhotoRequest {
  string room_id = 1 [(buf.validate.field).string.uuid = true];
  string user_id = 2 [(buf.validate.field).string.uuid = true];
  bytes image_data = 3 [(buf.validate.field).bytes = {
    min_len: 1
    max_len: 10485760
  }]; // max 10MB
}

message SubmitGameMasterPhotoResponse {
  string image_id = 1;
  repeated Hint hints = 2;
}

// SubmitHunterPhotoRequest submits a hunter's photo.
message SubmitHunterPhotoRequest {
  string room_id = 1 [(buf.validate.field).string.uuid = true];
  string user_id = 2 [(buf.validate.field).string.uuid = true];
  bytes image_data = 3 [(buf.validate.field).bytes = {
    min_len: 1
    max_len: 10485760
  }]; // max 10MB
  int32 elapsed_seconds = 4 [(buf.validate.field).int32 = {
    gte: 0
    lte: 60
  }];
}

message SubmitHunterPhotoResponse {
  string image_id = 1;
  bool all_hunters_submitted = 2; // True if all hunters have submitted their photos
}

// GetGameStateRequest gets the current game state.
message GetGameStateRequest {
  string room_id = 1 [(buf.validate.field).string.uuid = true];
}

message GetGameStateResponse {
  Game game = 1;
}

// StartNextRoundRequest starts the next round.
message StartNextRoundRequest {
  string room_id = 1 [(buf.validate.field).string.uuid = true];
  string game_master_user_id = 2 [(buf.validate.field).string.uuid = true];
}

message StartNextRoundResponse {
  Game game = 1;
}

// GetHunterPhotosRequest gets all hunter photo submissions for the current round.
message GetHunterPhotosRequest {
  string room_id = 1 [(buf.validate.field).string.uuid = true];
}

message GetHunterPhotosResponse {
  repeated HunterSubmission submissions = 1;
}

// RankSelection represents a ranking assigned by the game master.
message RankSelection {
  string user_id = 1 [(buf.validate.field).string.uuid = true];
  int32 rank = 2 [(buf.validate.field).int32 = {
    gte: 1
    lte: 20
  }];
}

// SelectWinnersRequest allows game master to select winners and assign ranks.
message SelectWinnersRequest {
  string room_id = 1 [(buf.validate.field).string.uuid = true];
  string game_master_user_id = 2 [(buf.validate.field).string.uuid = true];
  repeated RankSelection rankings = 3;
}

message SelectWinnersResponse {
  Game game = 1;
}

// EndGameRequest ends the game and calculates final rankings.
message EndGameRequest {
  string room_id = 1 [(buf.validate.field).string.uuid = true];
}

message EndGameResponse {
  Game game = 1;
  repeated Player final_rankings = 2;
}

service GameService {
  rpc StartGame(StartGameRequest) returns (StartGameResponse);
  rpc JoinGame(JoinGameRequest) returns (JoinGameResponse);
  rpc SubmitGameMasterPhoto(SubmitGameMasterPhotoRequest) returns (SubmitGameMasterPhotoResponse);
  rpc SubmitHunterPhoto(SubmitHunterPhotoRequest) returns (SubmitHunterPhotoResponse);
  rpc GetHunterPhotos(GetHunterPhotosRequest) returns (GetHunterPhotosResponse);
  rpc SelectWinners(SelectWinnersRequest) returns (SelectWinnersResponse);
  rpc GetGameState(GetGameStateRequest) returns (GetGameStateResponse);
  rpc StartNextRound(StartNextRoundRequest) returns (StartNextRoundResponse);
  rpc EndGame(EndGameRequest) returns (EndGameResponse);
}
